<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificaciones - Sistema Ciempiés</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 15px 25px;
            border-radius: 8px;
            margin: 5px 10px;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .sidebar .nav-link i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .user-info {
            background: white;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .message-preview {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
            <div class="user-info text-center">
                <i class="bi bi-person-circle" style="font-size: 4rem; color: #667eea;"></i>
                <h6 class="mt-2 mb-0" id="userName" style="color: #333;"></h6>
                <small id="userRole" style="color: #666;"></small>
            </div>

            <nav class="nav flex-column mt-3">
                <a class="nav-link" href="dashboard.html">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a class="nav-link" href="estudiantes.html">
                    <i class="bi bi-people-fill"></i> Estudiantes
                </a>
                <a class="nav-link" href="asistencias.html">
                    <i class="bi bi-clipboard-check"></i> Asistencias
                </a>
                <a class="nav-link" href="reportes.html">
                    <i class="bi bi-file-earmark-bar-graph"></i> Reportes
                </a>
                <a class="nav-link active" href="notificaciones.html">
                    <i class="bi bi-envelope-fill"></i> Notificaciones
                </a>
                <hr style="border-color: rgba(255,255,255,0.2);">
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 p-4">
            <!-- Header -->
            <div class="mb-4">
                <h2><i class="bi bi-envelope-fill text-primary"></i> Notificaciones Masivas</h2>
                <p class="text-muted mb-0">Envía correos electrónicos a todos los usuarios del sistema</p>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <div class="row">
                <!-- Formulario de Envío -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-pencil-square"></i> Redactar Correo Masivo
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="formNotificacion" onsubmit="enviarNotificacion(event)">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-tag-fill text-primary"></i> Asunto del Correo *
                                    </label>
                                    <input type="text" class="form-control" id="asunto"
                                           placeholder="Ej: Aviso Importante - Sistema Ciempiés"
                                           required maxlength="100">
                                    <small class="text-muted">Máximo 100 caracteres</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-chat-left-text-fill text-primary"></i> Mensaje *
                                    </label>
                                    <textarea class="form-control" id="mensaje" rows="8"
                                              required maxlength="1000"
                                              placeholder="Escribe aquí el mensaje que se enviará a todos los usuarios..."></textarea>
                                    <small class="text-muted">Máximo 1000 caracteres</small>
                                </div>

                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <strong>Nota:</strong> El correo se enviará a todos los usuarios activos del sistema
                                    (Administradores, Encargados y Monitores).
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg" id="btnEnviar">
                                        <i class="bi bi-send-fill"></i> Enviar Correos Masivos
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="limpiarFormulario()">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Vista Previa y Tips -->
                <div class="col-md-4">
                    <!-- Vista Previa -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-eye-fill text-primary"></i> Vista Previa
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="preview">
                                <small class="text-muted">La vista previa aparecerá aquí mientras escribes...</small>
                            </div>
                        </div>
                    </div>

                    <!-- Plantillas Rápidas -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-lightning-fill text-warning"></i> Plantillas Rápidas
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="usarPlantilla('reunion')">
                                    <i class="bi bi-calendar-event"></i> Reunión
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="usarPlantilla('aviso')">
                                    <i class="bi bi-exclamation-triangle"></i> Aviso
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="usarPlantilla('recordatorio')">
                                    <i class="bi bi-bell"></i> Recordatorio
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tips -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-lightbulb-fill text-warning"></i> Consejos
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="small mb-0">
                                <li>Sé claro y conciso en el asunto</li>
                                <li>Usa un tono profesional</li>
                                <li>Incluye fechas importantes</li>
                                <li>Revisa antes de enviar</li>
                                <li>Evita MAYÚSCULAS (parece gritar)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JS -->
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script>
    // Cargar información del usuario
    function loadUserInfo() {
        const user = getCurrentUser();
        if (user) {
            document.getElementById('userName').textContent =
                `${user.primerNombre} ${user.primerApellido}`;
            document.getElementById('userRole').textContent = user.rol;
        }
    }

    // Vista previa en tiempo real
    document.getElementById('asunto')?.addEventListener('input', actualizarPreview);
    document.getElementById('mensaje')?.addEventListener('input', actualizarPreview);

    function actualizarPreview() {
        const asunto = document.getElementById('asunto').value;
        const mensaje = document.getElementById('mensaje').value;

        const preview = document.getElementById('preview');

        if (asunto || mensaje) {
            preview.innerHTML = `
                <div class="message-preview">
                    <strong style="color: #667eea;">${asunto || '[Sin asunto]'}</strong>
                    <hr>
                    <p style="white-space: pre-wrap;">${mensaje || '[Sin mensaje]'}</p>
                    <hr>
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Sistema de Gestión Integral - Ciempiés
                    </small>
                </div>
            `;
        } else {
            preview.innerHTML = '<small class="text-muted">La vista previa aparecerá aquí...</small>';
        }
    }

    // Enviar notificación
    async function enviarNotificacion(event) {
        event.preventDefault();

        const asunto = document.getElementById('asunto').value;
        const mensaje = document.getElementById('mensaje').value;
        const btnEnviar = document.getElementById('btnEnviar');
        const originalText = btnEnviar.innerHTML;

        // Confirmar envío
        if (!confirm(`¿Estás seguro de enviar este correo a todos los usuarios?\n\nAsunto: ${asunto}`)) {
            return;
        }

        try {
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

            const response = await API.post('/notificaciones/enviar-masivo', {
                asunto: asunto,
                mensaje: mensaje
            });

            showAlert(
                `✅ Correos enviados exitosamente a ${response.destinatarios} usuarios`,
                'success'
            );

            // Limpiar formulario
            limpiarFormulario();

        } catch (error) {
            console.error('Error:', error);
            showAlert(error.message || 'Error al enviar los correos', 'danger');
        } finally {
            btnEnviar.disabled = false;
            btnEnviar.innerHTML = originalText;
        }
    }

    // Limpiar formulario
    function limpiarFormulario() {
        document.getElementById('formNotificacion').reset();
        actualizarPreview();
    }

    // Plantillas rápidas
    function usarPlantilla(tipo) {
        const asuntoInput = document.getElementById('asunto');
        const mensajeInput = document.getElementById('mensaje');

        const plantillas = {
            reunion: {
                asunto: 'Convocatoria a Reunión - Sistema Ciempiés',
                mensaje: `Estimado equipo,\n\nSe les convoca a reunión general este [DÍA] a las [HORA] en [LUGAR].\n\nTemas a tratar:\n- Punto 1\n- Punto 2\n- Punto 3\n\nPor favor confirmar asistencia.\n\nGracias,\nAdministración Sistema Ciempiés`
            },
            aviso: {
                asunto: 'Aviso Importante - Sistema Ciempiés',
                mensaje: `Estimado equipo,\n\nLes informamos que [DESCRIPCIÓN DEL AVISO].\n\nEsto aplicará a partir del [FECHA].\n\nPara más información, contactar con administración.\n\nGracias,\nSistema Ciempiés`
            },
            recordatorio: {
                asunto: 'Recordatorio - Sistema Ciempiés',
                mensaje: `Estimado equipo,\n\nLes recordamos que [EVENTO/ACTIVIDAD] se llevará a cabo el [FECHA] a las [HORA].\n\nNo olviden [ACCIÓN REQUERIDA].\n\nGracias,\nAdministración Sistema Ciempiés`
            }
        };

        if (plantillas[tipo]) {
            asuntoInput.value = plantillas[tipo].asunto;
            mensajeInput.value = plantillas[tipo].mensaje;
            actualizarPreview();
        }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        loadUserInfo();
    });
</script>
</body>
</html>